services:
  # Database for Keycloak and OpenFGA
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    logging:
      driver: json-file
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: keycloak
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infra/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - auth-net

  # Identity Provider
  keycloak:
    image: keycloak/keycloak:22.0
    container_name: keycloak
    logging:
      driver: json-file
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        mkdir -p /opt/keycloak/data/import
        cp /tmp/realm.json /opt/keycloak/data/import/
        sed "s|__AI_MANAGER_ADMIN_PASSWORD__|$$AI_MANAGER_ADMIN_PASSWORD|g" /tmp/ai-manager-realm.json.tmpl > /opt/keycloak/data/import/ai-manager-realm.json
        /opt/keycloak/bin/kc.sh start-dev --import-realm
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: ${POSTGRES_USER:-admin}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD:-password}
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_HTTP_RELATIVE_PATH: /login
      AI_MANAGER_ADMIN_PASSWORD: ${AI_MANAGER_ADMIN_PASSWORD:-admin}
    volumes:
      - ./infra/keycloak/realm.json:/tmp/realm.json:ro
      - ./infra/keycloak/ai-manager-realm.json:/tmp/ai-manager-realm.json.tmpl:ro
      - ./infra/keycloak/themes:/opt/keycloak/themes
    depends_on:
      - postgres
    networks:
      - auth-net

  # Fine-Grained Auth (ReBAC) — migrate schema
  openfga-migrate:
    image: openfga/openfga:latest
    container_name: openfga-migrate
    command: migrate
    environment:
      OPENFGA_DATASTORE_ENGINE: postgres
      OPENFGA_DATASTORE_URI: postgres://${POSTGRES_USER:-admin}:${POSTGRES_PASSWORD:-password}@postgres:5432/openfga?sslmode=disable
    depends_on:
      - postgres
    networks:
      - auth-net

  # Fine-Grained Auth (ReBAC) — run server
  openfga:
    image: openfga/openfga:latest
    container_name: openfga
    logging:
      driver: json-file
    command: run
    environment:
      OPENFGA_DATASTORE_ENGINE: postgres
      OPENFGA_DATASTORE_URI: postgres://${POSTGRES_USER:-admin}:${POSTGRES_PASSWORD:-password}@postgres:5432/openfga?sslmode=disable
    depends_on:
      - postgres
    ports:
      - "8081:8080" # HTTP API
      - "8082:8081" # gRPC API
      - "3001:3000" # Playground
    networks:
      - auth-net

  # OpenFGA bootstrap — create store + auth model (runs once)
  openfga-init:
    image: node:18-alpine
    container_name: openfga-init
    working_dir: /app
    command: node init.js
    environment:
      OPENFGA_URL: http://openfga:8080
    volumes:
      - ./infra/openfga/init.js:/app/init.js:ro
      - openfga_config:/shared
    depends_on:
      - openfga
    networks:
      - auth-net

  # Policy Engine (ABAC) with Envoy Plugin
  opa:
    image: openpolicyagent/opa:latest-envoy
    platform: linux/amd64
    container_name: opa
    logging:
      driver: json-file
    command:
      - "run"
      - "--server"
      - "--addr=0.0.0.0:8181"
      - "--log-level=debug"
      - "--config-file=/config/opa-config.yaml"
    volumes:
      - ./infra/opa/config.yaml:/config/opa-config.yaml
    ports:
      - "8181:8181"
      - "9191:9191"
    networks:
      - auth-net

  # Reverse Proxy
  envoy:
    image: envoyproxy/envoy:v1.26-latest
    logging:
      driver: json-file
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        sed "s|__EXTERNAL_URL__|$$EXTERNAL_URL|g" /etc/envoy/envoy.yaml.tmpl > /tmp/envoy.yaml
        sed "s|__TOKEN_SECRET__|$$ENVOY_TOKEN_SECRET|g" /etc/envoy/token_secret.yaml.tmpl > /tmp/token_secret.yaml
        sed "s|__HMAC_SECRET__|$$ENVOY_HMAC_SECRET|g" /etc/envoy/hmac_secret.yaml.tmpl > /tmp/hmac_secret.yaml
        /usr/local/bin/envoy -c /tmp/envoy.yaml
    container_name: envoy
    enable_ipv6: false
    env_file:
      - .env
    environment:
      EXTERNAL_URL: http://localhost:8000
    ports:
      - "8000:8000" # Public entry point
      - "9901:9901" # Admin interface
    volumes:
      - ./infra/envoy/envoy.yaml:/etc/envoy/envoy.yaml.tmpl
      - ./infra/envoy/token_secret.yaml.tmpl:/etc/envoy/token_secret.yaml.tmpl
      - ./infra/envoy/hmac_secret.yaml.tmpl:/etc/envoy/hmac_secret.yaml.tmpl
    networks:
      - auth-net

  # Protected Application (Animals demo)
  test-app:
    build:
      context: ./test-app
    container_name: test-app
    logging:
      driver: json-file
    environment:
      PORT: 3000
      OPENFGA_URL: http://openfga:8080
      EXTERNAL_URL: http://localhost:8000
    volumes:
      - openfga_config:/shared:ro
      - test_app_data:/data
    depends_on:
      - openfga
    networks:
      - auth-net

  # AI Authorization Manager (debug & policy management)
  ai-manager:
    build:
      context: ./ai-manager
    container_name: ai-manager
    logging:
      driver: json-file
    env_file:
      - .env
    environment:
      OPA_URL: http://opa:8181
      OPENFGA_URL: http://openfga:8080
      KEYCLOAK_INTERNAL_URL: http://keycloak:8080/login
      KEYCLOAK_EXTERNAL_URL: http://localhost:8000/login
      KEYCLOAK_REALM: AIManagerRealm
      KEYCLOAK_CLIENT_ID: ai-manager
      KEYCLOAK_CLIENT_SECRET: ${AI_MANAGER_CLIENT_SECRET:-ai-manager-secret}
      SESSION_SECRET: ${SESSION_SECRET:-change-me-to-a-random-string}
      EXTERNAL_URL: http://localhost:8000
    volumes:
      - ./infra/opa/policies:/policies
      - openfga_config:/shared:ro
    networks:
      - auth-net

  # --- Observability Stack ---

  # Log aggregation
  loki:
    image: grafana/loki:3.0.0
    container_name: loki
    command: -config.file=/etc/loki/loki-config.yaml
    volumes:
      - ./infra/loki/loki-config.yaml:/etc/loki/loki-config.yaml:ro
      - loki_data:/loki
    networks:
      - auth-net

  # Log collector (scrapes Docker container logs)
  promtail:
    image: grafana/promtail:3.0.0
    container_name: promtail
    user: root
    security_opt:
      - label:disable
    command: -config.file=/etc/promtail/promtail-config.yaml
    volumes:
      - ./infra/promtail/promtail-config.yaml:/etc/promtail/promtail-config.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - loki
    networks:
      - auth-net

  # Dashboards & log exploration
  grafana:
    image: grafana/grafana:11.0.0
    container_name: grafana
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD}
      GF_SERVER_ROOT_URL: http://localhost:8000/grafana/
      GF_SERVER_SERVE_FROM_SUB_PATH: "true"
      GF_AUTH_GENERIC_OAUTH_ENABLED: "true"
      GF_AUTH_GENERIC_OAUTH_NAME: Keycloak
      GF_AUTH_GENERIC_OAUTH_CLIENT_ID: grafana
      GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET: ${GRAFANA_CLIENT_SECRET}
      GF_AUTH_GENERIC_OAUTH_SCOPES: openid profile email
      GF_AUTH_GENERIC_OAUTH_AUTH_URL: http://localhost:8000/login/realms/AIManagerRealm/protocol/openid-connect/auth
      GF_AUTH_GENERIC_OAUTH_TOKEN_URL: http://keycloak:8080/login/realms/AIManagerRealm/protocol/openid-connect/token
      GF_AUTH_GENERIC_OAUTH_API_URL: http://keycloak:8080/login/realms/AIManagerRealm/protocol/openid-connect/userinfo
      GF_AUTH_GENERIC_OAUTH_ROLE_ATTRIBUTE_PATH: "contains(realm_access.roles[*], 'ai-admin') && 'Admin' || 'Viewer'"
      GF_AUTH_ANONYMOUS_ENABLED: "false"
    volumes:
      - ./infra/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./infra/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    depends_on:
      - loki
    networks:
      - auth-net

networks:
  auth-net:
    driver: bridge

volumes:
  postgres_data:
  openfga_config:
  test_app_data:
  loki_data:
  grafana_data:
