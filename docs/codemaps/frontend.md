# Frontend Codemap

> **Freshness:** 2026-02-04 | **Version:** 1.0.0

## Overview

Two frontend applications rendered server-side:
- **test-app** → Go templates (HTML)
- **ai-manager** → Static SPA (HTML + Vanilla JS)

---

## test-app Frontend

### Templates

```
test-app/internal/templates/
├── home.html      # Main dashboard (30KB)
└── dossiers.html  # Dossier management (47KB)
```

### home.html

**Purpose:** Landing page after authentication

**Sections:**
- Welcome message with current user
- Navigation to dossiers
- Quick status overview

**Data Context:**
```go
struct {
    User        string
    ExternalURL string
}
```

### dossiers.html

**Purpose:** Full dossier management UI with ReBAC features

**Sections:**
1. **My Dossiers** - List of user's accessible dossiers
2. **Create Dossier** - Form with title, content, type, orgId, public flag
3. **Guardianships** - Request/accept/deny workflow
4. **Organizations** - Create/manage organizations

**JavaScript Features:**
- Fetch API for all operations
- Dynamic list rendering
- Form handling with validation
- Toast notifications
- Live auto-refresh for demos

**API Calls:**
```javascript
// Dossiers
GET  /api/dossiers/list
POST /api/dossiers/create
PUT  /api/dossiers/{id}
DELETE /api/dossiers/{id}

// Relations
GET/POST/DELETE /api/dossiers/{id}/relations

// Public/Block
POST /api/dossiers/{id}/toggle-public
POST /api/dossiers/{id}/block
POST /api/dossiers/{id}/unblock

// Guardianships
GET /api/dossiers/guardianships
POST /api/dossiers/guardianships/request
POST /api/dossiers/guardianships/{id}/accept
POST /api/dossiers/guardianships/{id}/deny
DELETE /api/dossiers/guardianships/{id}

// Organizations
GET/POST /api/dossiers/organizations
POST/DELETE /api/dossiers/organizations/{id}/members
POST/DELETE /api/dossiers/organizations/{id}/admins
```

---

## ai-manager Frontend

### Files

```
ai-manager/public/
├── index.html    # SPA shell with tabs
└── app.js        # All frontend logic (1208 lines)
```

### index.html

**Structure:**
```html
<nav>Tab navigation</nav>
<main>
  <section id="generate">...</section>
  <section id="chat">...</section>
  <section id="openfga">...</section>
  <section id="dossiers">...</section>
  <section id="organizations">...</section>
  <section id="users">...</section>
  <section id="visualize">...</section>
  <section id="audit">...</section>
</main>
<script src="mermaid.min.js"></script>
<script src="app.js"></script>
```

### app.js

**Tab System:**
```javascript
const tabs = [
  'generate',      // AI rule generation
  'chat',          // Policy chat
  'openfga',       // Tuple management
  'dossiers',      // Dossier admin
  'organizations', // Org admin
  'users',         // User overview
  'visualize',     // Mermaid diagrams
  'audit'          // Audit logs
];
```

**Key Functions:**

| Function | Tab | Purpose |
|----------|-----|---------|
| `generateRule()` | generate | Send prompt to AI, display generated rules |
| `applyPolicy()` | generate | Apply rules to OPA policy file |
| `sendChat()` | chat | Conversational AI interaction |
| `loadTuples()` | openfga | Fetch and display FGA tuples |
| `addTuple()` | openfga | Add new tuple |
| `deleteTuple()` | openfga | Remove tuple |
| `loadModel()` | openfga | Display authorization model |
| `checkPermission()` | openfga | Test user permission |
| `loadDossiers()` | dossiers | Display all dossiers |
| `updateDossier()` | dossiers | Edit dossier |
| `deleteDossier()` | dossiers | Remove dossier |
| `togglePublic()` | dossiers | Toggle public flag |
| `blockUser()` | dossiers | Block user from dossier |
| `loadOrganizations()` | organizations | Display orgs with members |
| `addAdmin()` | organizations | Promote to admin |
| `removeAdmin()` | organizations | Demote admin |
| `loadUsersAndGuardianships()` | users | Display relationships |
| `renderArchitectureDiagram()` | visualize | System overview |
| `renderOpaViz()` | visualize | OPA policy flow |
| `renderFgaViz()` | visualize | FGA relationships |
| `loadAuditLogs()` | audit | Display audit entries |

**Visualization (Mermaid.js):**

```javascript
// Architecture diagram
graph LR
  User --> Envoy
  Envoy --> OPA
  OPA --> OpenFGA
  Envoy --> App

// OPA policy flow
flowchart TD
  Request --> PublicPath?
  PublicPath? -->|yes| Allow
  PublicPath? -->|no| VerifyJWT
  VerifyJWT --> EvaluateRules
  EvaluateRules --> Allow/Deny

// FGA relationships
graph TD
  user:alice --owner--> dossier:d1
  user:bob --member--> organization:bosa
  organization:bosa --org_parent--> dossier:d1
```

**State Management:**
- Session storage for auth state
- Local variables for loaded data
- No framework (vanilla JS)

---

## OPA 403 Page

**Location:** Generated by `infra/opa/policies/policy.rego`

**Features:**
- Custom HTML embedded in Rego
- "Explain with AI" button
- Calls `/manager/api/explain-authz`
- Markdown rendering for AI response (uses marked.js library)
- Styled error page with rejection reason

**Note:** The 403 page uses marked.js to render AI explanations as HTML. This is existing behavior in the OPA policy.

---

## Styling

**test-app:** Inline styles in templates (minimal, functional)

**ai-manager:**
- CSS in index.html `<style>` block
- Tab-based navigation
- Form styling
- Table layouts for data display
- Mermaid diagram containers

**OPA 403:** Inline styles in Rego string (dark theme)
