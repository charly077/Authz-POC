<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuthZ POC - Citizen Mandate System</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Nunito+Sans:wght@400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #faf8f5; --surface: #f0ebe4; --surface-hover: #e8e2d9;
            --border: #e0d8ce; --text: #2c2420; --text-muted: #8c7e72;
            --rose: #c4a097; --rose-deep: #a8786d; --rose-bg: #ecddd8;
            --sage: #6b9080; --sage-bg: #dfe9e3; --sage-deep: #4a7a64;
            --warm-dark: #3d302a; --danger: #c0544f; --danger-bg: #f5e0de;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Nunito Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

        nav { display: flex; align-items: center; justify-content: space-between; padding: 1.1rem 2.5rem;
            background: white; border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 100; }
        .nav-brand { display: flex; align-items: center; gap: 0.6rem; }
        .nav-logo { width: 34px; height: 34px; background: var(--warm-dark);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 0.95rem; font-weight: 700; color: white; font-family: 'Cormorant Garamond', serif; }
        .nav-title { font-family: 'Cormorant Garamond', serif; font-size: 1.25rem; font-weight: 700; color: var(--text); }
        .nav-links { display: flex; align-items: center; gap: 0.15rem; }
        .nav-links a { color: var(--text-muted); text-decoration: none; padding: 0.45rem 1rem; border-radius: 999px;
            font-size: 0.88rem; font-weight: 600; transition: all 0.2s; }
        .nav-links a:hover { color: var(--text); background: var(--surface); }
        .nav-links a.active { color: white; background: var(--warm-dark); }
        .nav-user { display: flex; align-items: center; gap: 0.75rem; }
        .user-badge { display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem 0.85rem;
            background: var(--surface); border-radius: 999px; }
        .user-avatar { width: 26px; height: 26px; border-radius: 50%; background: var(--rose);
            display: flex; align-items: center; justify-content: center;
            font-size: 0.72rem; font-weight: 800; color: white; text-transform: uppercase; }
        .user-name { font-size: 0.88rem; font-weight: 600; color: var(--text); }
        .btn-logout { display: inline-flex; align-items: center; padding: 0.4rem 1rem;
            background: transparent; border: 1.5px solid var(--border); color: var(--text-muted);
            border-radius: 999px; text-decoration: none; font-size: 0.82rem; font-weight: 600; transition: all 0.2s; }
        .btn-logout:hover { border-color: var(--danger); color: var(--danger); background: var(--danger-bg); }

        .container { max-width: 920px; margin: 0 auto; padding: 3rem 2rem; }
        .page-header { margin-bottom: 2.5rem; }
        .page-header h1 { font-family: 'Cormorant Garamond', serif; font-size: 2.6rem; font-weight: 700;
            line-height: 1.15; margin-bottom: 0.5rem; }
        .page-header h1 em { font-style: italic; color: var(--rose-deep); }
        .page-header p { color: var(--text-muted); font-size: 0.95rem; }

        .card { background: white; border-radius: 14px; padding: 1.5rem; margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .card h3 { font-family: 'Cormorant Garamond', serif; color: var(--text); margin-bottom: 0.75rem;
            font-size: 1.2rem; font-weight: 700; }
        .card h4 { color: var(--text-muted); font-size: 0.78rem; margin-top: 0.75rem; margin-bottom: 0.25rem;
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; }

        .top-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .guardianship-list { margin-bottom: 0.75rem; }
        .guardian-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0; font-weight: 500; }
        .guardianship-request-form { display: flex; gap: 0.5rem; margin-top: 0.75rem; }

        input[type="text"], input[type="number"], select, textarea {
            width: 100%; padding: 0.55rem 0.85rem; margin-bottom: 0.5rem; border-radius: 10px;
            border: 1.5px solid var(--border); background: var(--bg); color: var(--text);
            font-family: 'Nunito Sans', sans-serif; font-size: 0.9rem; }
        textarea { min-height: 80px; resize: vertical; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--rose); }

        .guardianship-request-form select { flex: 1; margin-bottom: 0; }
        .guardianship-request-form input { flex: 1; margin-bottom: 0; }

        .btn { padding: 0.5rem 1rem; border-radius: 999px; font-weight: 700; cursor: pointer; border: none;
            transition: all 0.2s; font-family: 'Nunito Sans', sans-serif; font-size: 0.85rem; }
        .btn-primary { background: var(--warm-dark); color: white; }
        .btn-primary:hover { background: #2c2420; box-shadow: 0 4px 14px rgba(61,48,42,0.2); }
        .btn-danger { background: var(--danger-bg); color: var(--danger); }
        .btn-danger:hover { background: #f0ccc9; }
        .btn-success { background: var(--sage-bg); color: var(--sage-deep); }
        .btn-success:hover { background: #d0dfd5; }
        .btn-secondary { background: var(--surface); color: var(--text); }
        .btn-sm { padding: 0.35rem 0.8rem; font-size: 0.78rem; }
        .btn-xs { padding: 0.22rem 0.55rem; font-size: 0.72rem; line-height: 1; }

        .dossiers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 0.85rem; margin-top: 0.75rem; }
        .dossier-card { background: var(--bg); border-radius: 14px; padding: 1.1rem;
            transition: box-shadow 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
        .dossier-card:hover { box-shadow: 0 4px 14px rgba(0,0,0,0.07); }
        .dossier-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .dossier-card-header strong { font-family: 'Cormorant Garamond', serif; font-weight: 700; font-size: 1.1rem; }
        .dossier-owner { color: var(--text-muted); font-size: 0.78rem; }
        .type-badge { display: inline-block; padding: 0.15rem 0.6rem; border-radius: 999px; font-size: 0.72rem;
            font-weight: 700; margin-right: 0.5rem; }
        .type-tax { background: #faf0d4; color: #9a7b2c; }
        .type-health { background: var(--sage-bg); color: var(--sage-deep); }
        .type-general { background: var(--rose-bg); color: var(--rose-deep); }
        .badge-public { display: inline-block; padding: 0.12rem 0.5rem; border-radius: 999px; font-size: 0.65rem;
            font-weight: 700; background: #d4e8fa; color: #2c6fb5; margin-left: 0.3rem; }
        .badge-org { display: inline-block; padding: 0.12rem 0.5rem; border-radius: 999px; font-size: 0.65rem;
            font-weight: 700; background: #e8d4fa; color: #7b2cb5; margin-left: 0.3rem; }
        .badge-blocked { display: inline-block; padding: 0.12rem 0.5rem; border-radius: 999px; font-size: 0.65rem;
            font-weight: 700; background: var(--danger-bg); color: var(--danger); margin-left: 0.3rem; }
        .org-member { display: flex; align-items: center; gap: 0.4rem; padding: 0.25rem 0; font-size: 0.85rem; }
        .org-card { background: var(--bg); border-radius: 12px; padding: 0.85rem; margin-bottom: 0.5rem; }
        .emergency-panel { background: #fff8e1; border: 1.5px solid #f0d68a; border-radius: 12px; padding: 1.25rem; margin-top: 1rem; }
        .emergency-panel h4 { color: #9a7b2c; margin-bottom: 0.5rem; font-family: 'Cormorant Garamond', serif; font-size: 1.1rem; }
        .emergency-result { margin-top: 0.75rem; padding: 0.75rem; border-radius: 8px; font-weight: 600; font-size: 0.88rem; }
        .emergency-allowed { background: var(--sage-bg); color: var(--sage-deep); }
        .emergency-denied { background: var(--danger-bg); color: var(--danger); }
        .dossier-content { color: var(--text-muted); font-size: 0.82rem; margin-top: 0.4rem;
            overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .dossier-actions { margin-top: 0.75rem; display: flex; gap: 0.4rem; }
        .dossier-relations { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border); }
        .dossier-relations h5 { color: var(--text-muted);
            font-size: 0.72rem; margin-bottom: 0.4rem; text-transform: uppercase; letter-spacing: 0.06em; font-weight: 700; }
        .relation-item { display: flex; align-items: center; gap: 0.4rem; padding: 0.2rem 0; font-size: 0.82rem; }
        .relation-badge { display: inline-block; padding: 0.12rem 0.5rem; border-radius: 999px; font-size: 0.65rem;
            font-weight: 700; text-transform: uppercase; }
        .relation-owner { background: #faf0d4; color: #9a7b2c; }
        .relation-mandate_holder { background: #dce8f8; color: #3b6fb5; }
        .grant-mandate-form { display: flex; gap: 0.35rem; margin-top: 0.4rem; }
        .grant-mandate-form select { flex: 1; margin-bottom: 0; padding: 0.25rem 0.4rem; font-size: 0.72rem; }

        .muted { color: var(--text-muted); font-size: 0.82rem; }

        .debug-section { margin-top: 1rem; }
        .debug-toggle { cursor: pointer; user-select: none; color: var(--text-muted); font-size: 0.9rem; }
        .debug-table { width: 100%; border-collapse: collapse; margin-top: 0.75rem; font-size: 0.82rem; }
        .debug-table th, .debug-table td { text-align: left; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); }
        .debug-table th { color: var(--rose-deep); font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.04em; font-size: 0.72rem; }
        .debug-table td { color: #5a4d44; font-family: 'IBM Plex Mono', monospace; font-size: 0.78rem; }

        .toast { position: fixed; bottom: 2rem; right: 2rem; padding: 0.9rem 1.4rem; border-radius: 999px;
            color: white; font-weight: 700; z-index: 1000; font-size: 0.88rem;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards; }
        .toast-success { background: var(--sage-deep); }
        .toast-error { background: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        footer { display: flex; align-items: center; justify-content: space-between; padding: 2rem 2.5rem;
            color: var(--text-muted); font-size: 0.8rem; border-top: 1px solid var(--border); margin-top: 3rem; }
        footer a { color: var(--rose-deep); text-decoration: none; font-weight: 700; }

        .ai-explain-box { background: white; border-radius: 14px; padding: 1.5rem; margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .ai-explain-box h3 { font-family: 'Cormorant Garamond', serif; color: var(--text);
            margin-bottom: 0.5rem; font-size: 1.2rem; font-weight: 700; }
        .ai-explain-box p.desc { color: var(--text-muted); font-size: 0.88rem; margin-bottom: 1rem; }
        .ai-explain-btn { padding: 0.6rem 1.4rem; border-radius: 999px; font-weight: 700; cursor: pointer; border: none;
            background: var(--warm-dark); color: white; font-family: 'Nunito Sans', sans-serif;
            font-size: 0.9rem; transition: all 0.2s; }
        .ai-explain-btn:hover { background: #2c2420; box-shadow: 0 4px 14px rgba(61,48,42,0.25); }
        .ai-explain-btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
        .ai-explain-spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white; border-radius: 50%; animation: aispin 0.6s linear infinite; margin-right: 0.4rem; vertical-align: middle; }
        @keyframes aispin { to { transform: rotate(360deg); } }
        .ai-explain-result { margin-top: 1rem; padding: 1.25rem; background: var(--bg);
            border-radius: 12px; line-height: 1.75; font-size: 0.9rem; color: #5a4d44; }
        .ai-explain-result h1, .ai-explain-result h2, .ai-explain-result h3, .ai-explain-result h4 {
            font-family: 'Cormorant Garamond', serif; color: var(--text); margin: 1rem 0 0.5rem 0; }
        .ai-explain-result h1 { font-size: 1.3rem; } .ai-explain-result h2 { font-size: 1.15rem; }
        .ai-explain-result h3 { font-size: 1.05rem; } .ai-explain-result h4 { font-size: 0.95rem; }
        .ai-explain-result ul, .ai-explain-result ol { padding-left: 1.5rem; margin: 0.5rem 0; }
        .ai-explain-result li { margin-bottom: 0.3rem; }
        .ai-explain-result code { background: var(--rose-bg); padding: 0.12rem 0.4rem; border-radius: 5px;
            font-family: 'IBM Plex Mono', monospace; font-size: 0.82rem; color: var(--rose-deep); }
        .ai-explain-result strong { color: var(--text); }
        .ai-explain-error { color: var(--danger); margin-top: 1rem; }

        @media (max-width: 640px) {
            nav { padding: 0.8rem 1rem; flex-wrap: wrap; gap: 0.75rem; }
            .nav-links { display: none; }
            .container { padding: 1.5rem 1.25rem; }
            .page-header h1 { font-size: 1.9rem; }
            .top-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-brand">
            <div class="nav-logo">A</div>
            <span class="nav-title">AuthZ POC</span>
        </div>
        <div class="nav-links">
            <a href="/home">Home</a>
            <a href="/public">Public</a>
            <a href="/api/protected">Protected</a>
            <a href="/dossiers" class="active">Dossiers</a>
            <a href="/api/health">Health</a>
        </div>
        <div class="nav-user">
            <div class="user-badge">
                <div class="user-avatar">{{index .Username 0 | printf "%c"}}</div>
                <span class="user-name">{{.Username}}</span>
            </div>
            <a href="/logout" class="btn-logout">Sign out</a>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1><em>Citizen Mandate System</em></h1>
            <p>Manage dossiers with OpenFGA relationship-based access control. Logged in as <strong>{{.Username}}</strong>.</p>
        </div>

        <div id="app">Loading...</div>
    </div>

    <footer>
        <span>Fine-Grained Authorization POC</span>
        <a href="/manager" target="_blank">AuthZ Rule Builder &rarr;</a>
    </footer>

    <script>
    const currentUser = '{{.Username}}';
    const apiBase = '/api/dossiers';

    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function showToast(msg, type) {
        const t = document.createElement('div');
        t.className = 'toast toast-' + (type || 'success');
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    async function api(path, opts) {
        const res = await fetch(apiBase + path, {
            headers: { 'Content-Type': 'application/json', ...(opts?.headers || {}) },
            ...opts
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Request failed');
        return data;
    }

    async function render() {
        const app = document.getElementById('app');
        try {
            const [dossiersData, guardianshipsData, orgsData] = await Promise.all([
                api('/list'),
                api('/guardianships'),
                api('/organizations')
            ]);

            const allDossiers = dossiersData.dossiers || [];
            const myDossiers = allDossiers.filter(d => d.owner === currentUser);
            const sharedDossiers = allDossiers.filter(d => d.owner !== currentUser);
            const guardians = guardianshipsData.guardians || [];
            const wards = guardianshipsData.wards || [];
            const incoming = guardianshipsData.incoming || [];
            const outgoing = guardianshipsData.outgoing || [];

            const organizations = orgsData.organizations || [];
            const relatedUsers = [...new Set([...guardians, ...wards])];

            app.innerHTML = '' +
                '<div class="top-row">' +
                '  <div class="card">' +
                '    <h3>Guardianships</h3>' +
                '    <div class="guardianship-list">' +
                (guardians.length > 0 ? '<h4>My Guardians</h4>' +
                    guardians.map(function(g) { return '<div class="guardian-item"><span>' + escapeHtml(g) + '</span>' +
                        '<button class="btn btn-danger btn-sm" onclick="removeGuardianship(\'' + escapeHtml(g) + '\')">Remove</button></div>'; }).join('') : '') +
                (wards.length > 0 ? '<h4>My Wards</h4>' +
                    wards.map(function(w) { return '<div class="guardian-item"><span>' + escapeHtml(w) + '</span>' +
                        '<button class="btn btn-danger btn-sm" onclick="removeGuardianship(\'' + escapeHtml(w) + '\')">Remove</button></div>'; }).join('') : '') +
                (guardians.length === 0 && wards.length === 0 ? '<p class="muted">No guardianships yet</p>' : '') +
                '    </div>' +
                (incoming.length > 0 ? '<h4>Incoming Requests</h4>' +
                    incoming.map(function(r) { return '<div class="guardian-item"><span>' + escapeHtml(r.from) + ' wants to guard you</span>' +
                        '<button class="btn btn-success btn-sm" onclick="acceptGuardianship(\'' + r.id + '\')">Accept</button>' +
                        '<button class="btn btn-danger btn-sm" onclick="denyGuardianship(\'' + r.id + '\')">Deny</button></div>'; }).join('') : '') +
                (outgoing.length > 0 ? '<h4>Outgoing Requests</h4>' +
                    outgoing.map(function(r) { return '<div class="guardian-item"><span>Request to guard: ' + escapeHtml(r.to) + '</span> <span class="muted">pending</span></div>'; }).join('') : '') +
                '    <div class="guardianship-request-form">' +
                '      <input type="text" id="guardianTarget" placeholder="Username">' +
                '      <button class="btn btn-primary btn-sm" onclick="sendGuardianshipRequest()">Request to Guard</button>' +
                '    </div>' +
                '  </div>' +
                '  <div class="card">' +
                '    <h3>New Dossier</h3>' +
                '    <input type="text" id="dossierTitle" placeholder="Title">' +
                '    <select id="dossierType">' +
                '      <option value="tax">Tax</option>' +
                '      <option value="health">Health</option>' +
                '      <option value="general">General</option>' +
                '    </select>' +
                '    <textarea id="dossierContent" placeholder="Content"></textarea>' +
                '    <select id="dossierOrg"><option value="">No organization</option>' +
                     organizations.map(function(o) { return '<option value="' + o.id + '">' + escapeHtml(o.name) + '</option>'; }).join('') +
                '    </select>' +
                '    <label style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;font-size:0.88rem;">' +
                '      <input type="checkbox" id="dossierPublic"> Make public (visible to all users)' +
                '    </label>' +
                '    <button class="btn btn-primary" onclick="createDossier()">Create</button>' +
                '  </div>' +
                '</div>' +
                '<div class="card">' +
                '  <h3>Organizations</h3>' +
                (organizations.length === 0 ? '<p class="muted">No organizations yet.</p>' :
                    organizations.map(function(o) {
                        var isAdmin = o.admins && o.admins.indexOf(currentUser) !== -1;
                        var safeId = escapeHtml(o.id);
                        return '<div class="org-card">' +
                            '<div style="display:flex;justify-content:space-between;align-items:center;">' +
                            '<strong>' + escapeHtml(o.name) + '</strong>' +
                            '<div style="display:flex;gap:0.35rem;align-items:center;">' +
                            '<span class="badge-org">ID: ' + safeId + '</span>' +
                            (isAdmin ? '<button class="btn btn-danger btn-xs" onclick="deleteOrg(\'' + safeId + '\',\'' + escapeHtml(o.name) + '\')">Delete Org</button>' : '') +
                            '</div></div>' +
                            '<h4 style="margin-top:0.5rem;">Admins</h4>' +
                            (o.admins && o.admins.length > 0 ? o.admins.map(function(a) {
                                return '<div class="org-member"><span>' + escapeHtml(a) + '</span>' +
                                    '<span class="relation-badge" style="background:#faf0d4;color:#9a7b2c;margin-left:0.3rem;">admin</span>' +
                                    (isAdmin ? '<button class="btn btn-danger btn-xs" onclick="removeOrgAdmin(\'' + safeId + '\',\'' + escapeHtml(a) + '\')">&times;</button>' : '') +
                                    '</div>';
                            }).join('') : '<p class="muted">No admins</p>') +
                            (isAdmin ? '<div style="display:flex;gap:0.35rem;margin-top:0.4rem;">' +
                            '<input type="text" id="orgAdmin_' + safeId + '" placeholder="Username" style="margin-bottom:0;">' +
                            '<button class="btn btn-primary btn-sm" onclick="addOrgAdmin(\'' + safeId + '\')">Add Admin</button>' +
                            '</div>' : '') +
                            '<h4 style="margin-top:0.5rem;">Members</h4>' +
                            (o.members && o.members.length > 0 ? o.members.map(function(m) {
                                var memberIsAdmin = o.admins && o.admins.indexOf(m) !== -1;
                                return '<div class="org-member"><span>' + escapeHtml(m) + '</span>' +
                                    (memberIsAdmin ? '<span class="relation-badge" style="background:#faf0d4;color:#9a7b2c;margin-left:0.3rem;">admin</span>' : '') +
                                    (isAdmin ? '<button class="btn btn-danger btn-xs" onclick="removeOrgMember(\'' + safeId + '\',\'' + escapeHtml(m) + '\')">&times;</button>' : '') +
                                    '</div>';
                            }).join('') : '<p class="muted">No members</p>') +
                            (isAdmin ? '<div style="display:flex;gap:0.35rem;margin-top:0.4rem;">' +
                            '<input type="text" id="orgMember_' + safeId + '" placeholder="Username" style="margin-bottom:0;">' +
                            '<button class="btn btn-primary btn-sm" onclick="addOrgMember(\'' + safeId + '\')">Add Member</button>' +
                            '</div>' : '') +
                            '</div>';
                    }).join('')) +
                '  <h4 style="margin-top:1rem;">Create Organization</h4>' +
                '  <div style="display:flex;gap:0.5rem;margin-top:0.4rem;">' +
                '    <input type="text" id="newOrgName" placeholder="Organization name" style="margin-bottom:0;">' +
                '    <button class="btn btn-primary btn-sm" onclick="createOrg()">Create</button>' +
                '  </div>' +
                '</div>' +
                '<div class="card">' +
                '  <h3>My Dossiers</h3>' +
                '  <div class="dossiers-grid">' +
                (myDossiers.length === 0 ? '<p class="muted">No dossiers yet. Create one above.</p>' :
                    myDossiers.map(function(d) { return renderDossierCard(d, relatedUsers); }).join('')) +
                '  </div>' +
                '</div>' +
                (sharedDossiers.length > 0 ? '<div class="card"><h3>Shared With Me</h3><div class="dossiers-grid">' +
                    sharedDossiers.map(function(d) { return renderDossierCard(d, relatedUsers); }).join('') + '</div></div>' : '') +
                '<div class="card debug-section">' +
                '  <h3 class="debug-toggle" onclick="toggleDebug()">Debug: OpenFGA Tuples <span id="debugArrow">&#9654;</span></h3>' +
                '  <div id="debugContent" style="display:none;">' +
                '    <button class="btn btn-secondary btn-sm" onclick="refreshDebug()">Refresh</button>' +
                '    <table class="debug-table"><thead><tr><th>User</th><th>Relation</th><th>Object</th></tr></thead>' +
                '    <tbody id="debugBody"></tbody></table>' +
                '  </div>' +
                '</div>' +
                '<div class="card emergency-panel">' +
                '  <h4>Emergency Access Check</h4>' +
                '  <p class="muted">Simulate temporary access using contextual tuples (non-persisted, per-check only).</p>' +
                '  <div style="display:flex;gap:0.5rem;margin-top:0.75rem;flex-wrap:wrap;">' +
                '    <input type="text" id="emergencyUser" placeholder="Username" style="flex:1;min-width:120px;margin-bottom:0;">' +
                '    <input type="text" id="emergencyDossier" placeholder="Dossier ID" style="flex:1;min-width:120px;margin-bottom:0;">' +
                '    <button class="btn btn-primary btn-sm" onclick="emergencyCheck()">Check Emergency Access</button>' +
                '  </div>' +
                '  <div id="emergencyResult"></div>' +
                '</div>' +
                '<div class="ai-explain-box">' +
                '  <h3>AuthZ Decision Explained by AI</h3>' +
                '  <p class="desc">Click the button below to get an AI-powered explanation of your current authorization state — why you can see certain dossiers and what relationships grant you access.</p>' +
                '  <button class="ai-explain-btn" id="aiExplainBtn" onclick="requestAIExplanation()">Explain My Authorization</button>' +
                '  <div id="aiExplainResult"></div>' +
                '</div>';
        } catch (e) {
            app.innerHTML = '<div class="card"><p>Error loading data: ' + escapeHtml(e.message) + '</p></div>';
        }
    }

    function renderDossierCard(dossier, relatedUsers) {
        var rels = dossier.relations || [];
        var editable = dossier.canEdit;
        var blocked = dossier.blockedUsers || [];
        var html = '<div class="dossier-card">' +
            '<div class="dossier-card-header"><strong>' + escapeHtml(dossier.title) + '</strong>' +
            (dossier.owner !== currentUser ? '<span class="dossier-owner">(' + escapeHtml(dossier.owner) + ')</span>' : '') +
            '</div>' +
            '<span class="type-badge type-' + escapeHtml(dossier.type) + '">' + escapeHtml(dossier.type) + '</span>' +
            (dossier.isPublic ? '<span class="badge-public">PUBLIC</span>' : '') +
            (dossier.orgId ? '<span class="badge-org">ORG</span>' : '') +
            (blocked.length > 0 ? '<span class="badge-blocked">' + blocked.length + ' blocked</span>' : '');

        if (dossier.content) {
            html += '<div class="dossier-content">' + escapeHtml(dossier.content) + '</div>';
        }

        if (editable) {
            html += '<div class="dossier-actions">' +
                '<button class="btn btn-secondary btn-sm" onclick="editDossier(\'' + dossier.id + '\',\'' + escapeHtml(dossier.title) + '\',\'' + escapeHtml(dossier.content || '') + '\',\'' + escapeHtml(dossier.type) + '\')">Edit</button>' +
                '<button class="btn btn-danger btn-sm" onclick="deleteDossier(\'' + dossier.id + '\')">Delete</button>' +
                (dossier.owner === currentUser ? '<button class="btn ' + (dossier.isPublic ? 'btn-danger' : 'btn-success') + ' btn-sm" onclick="togglePublic(\'' + dossier.id + '\')">' + (dossier.isPublic ? 'Make Private' : 'Make Public') + '</button>' : '') +
                '</div>' +
                (dossier.owner === currentUser ? '<div style="display:flex;gap:0.35rem;margin-top:0.4rem;">' +
                    '<input type="text" id="blockUser_' + dossier.id + '" placeholder="Block user..." style="margin-bottom:0;padding:0.25rem 0.4rem;font-size:0.72rem;flex:1;">' +
                    '<button class="btn btn-danger btn-xs" onclick="blockUser(\'' + dossier.id + '\')">Block</button></div>' +
                    (blocked.length > 0 ? blocked.map(function(b) {
                        return '<div class="relation-item"><span class="badge-blocked">' + escapeHtml(b) + '</span>' +
                            '<button class="btn btn-success btn-xs" onclick="unblockUser(\'' + dossier.id + '\',\'' + escapeHtml(b) + '\')">Unblock</button></div>';
                    }).join('') : '') : '') +
                '<div class="dossier-relations"><h5>Relations</h5>' +
                (rels.length > 0 ? rels.map(function(r) { return '<div class="relation-item">' +
                    '<span class="relation-badge relation-' + r.relation + '">' + r.relation.replace('_', ' ') + '</span>' +
                    '<span>' + escapeHtml(r.user) + '</span>' +
                    '<button class="btn btn-danger btn-xs" onclick="removeRelation(\'' + dossier.id + '\',\'' + escapeHtml(r.user) + '\',\'' + r.relation + '\')">&times;</button>' +
                    '</div>'; }).join('') : '<p class="muted">None</p>') +
                (relatedUsers.length > 0 ? '<div class="grant-mandate-form">' +
                    '<select id="relUser_' + dossier.id + '">' + relatedUsers.map(function(u) { return '<option value="' + u + '">' + u + '</option>'; }).join('') + '</select>' +
                    '<button class="btn btn-primary btn-xs" onclick="grantMandate(\'' + dossier.id + '\')">Grant Mandate</button></div>' : '<p class="muted">Add guardianships to grant mandates</p>') +
                '</div>';
        }
        html += '</div>';
        return html;
    }

    async function createDossier() {
        var title = document.getElementById('dossierTitle').value.trim();
        var content = document.getElementById('dossierContent').value.trim();
        var type = document.getElementById('dossierType').value;
        var orgSelect = document.getElementById('dossierOrg');
        var orgId = orgSelect ? orgSelect.value : '';
        var publicCheck = document.getElementById('dossierPublic');
        var isPublic = publicCheck ? publicCheck.checked : false;
        if (!title) { showToast('Title is required', 'error'); return; }
        try {
            var payload = { title: title, content: content, type: type };
            if (orgId) payload.orgId = orgId;
            if (isPublic) payload.public = true;
            await api('/create', { method: 'POST', body: JSON.stringify(payload) });
            showToast('Dossier created!');
            render();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function editDossier(id, title, content, type) {
        var newTitle = prompt('Title:', title);
        if (newTitle === null) return;
        var newContent = prompt('Content:', content);
        if (newContent === null) return;
        var newType = prompt('Type (tax/health/general):', type);
        if (newType === null) return;
        try {
            await api('/' + id, { method: 'PUT', body: JSON.stringify({ title: newTitle, content: newContent, type: newType }) });
            showToast('Dossier updated!');
            render();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteDossier(id) {
        if (!confirm('Delete this dossier?')) return;
        try {
            await api('/' + id, { method: 'DELETE' });
            showToast('Dossier deleted');
            render();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function grantMandate(dossierId) {
        var u = document.getElementById('relUser_' + dossierId);
        if (!u) return;
        try {
            await api('/' + dossierId + '/relations', { method: 'POST', body: JSON.stringify({ targetUser: u.value }) });
            showToast('Mandate granted!');
            render();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function removeRelation(dossierId, targetUser, relation) {
        try {
            await api('/' + dossierId + '/relations', { method: 'DELETE', body: JSON.stringify({ targetUser: targetUser, relation: relation }) });
            showToast('Relation removed');
            render();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function togglePublic(dossierId) {
        try {
            await api('/' + dossierId + '/toggle-public', { method: 'POST' });
            showToast('Public status toggled!');
            render();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function blockUser(dossierId) {
        var input = document.getElementById('blockUser_' + dossierId);
        var targetUser = input ? input.value.trim() : '';
        if (!targetUser) { showToast('Enter a username to block', 'error'); return; }
        try {
            await api('/' + dossierId + '/block', { method: 'POST', body: JSON.stringify({ targetUser: targetUser }) });
            showToast('User blocked!');
            render();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function unblockUser(dossierId, targetUser) {
        try {
            await api('/' + dossierId + '/unblock', { method: 'POST', body: JSON.stringify({ targetUser: targetUser }) });
            showToast('User unblocked');
            render();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function createOrg() {
        var nameInput = document.getElementById('newOrgName');
        var name = nameInput ? nameInput.value.trim() : '';
        if (!name) { showToast('Organization name is required', 'error'); return; }
        try {
            await api('/organizations', { method: 'POST', body: JSON.stringify({ name: name, members: [] }) });
            showToast('Organization created!');
            render();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function addOrgMember(orgId) {
        var input = document.getElementById('orgMember_' + orgId);
        var member = input ? input.value.trim() : '';
        if (!member) return;
        try {
            await api('/organizations/' + orgId + '/members', { method: 'POST', body: JSON.stringify({ member: member }) });
            showToast('Member added!');
            render();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function removeOrgMember(orgId, member) {
        try {
            await api('/organizations/' + orgId + '/members', { method: 'DELETE', body: JSON.stringify({ member: member }) });
            showToast('Member removed');
            render();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function addOrgAdmin(orgId) {
        var input = document.getElementById('orgAdmin_' + orgId);
        var user = input ? input.value.trim() : '';
        if (!user) return;
        try {
            await api('/organizations/' + orgId + '/admins', { method: 'POST', body: JSON.stringify({ user: user }) });
            showToast('Admin added!');
            render();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function removeOrgAdmin(orgId, user) {
        var confirmMsg = user === currentUser
            ? 'Remove yourself as admin? You will lose management access.'
            : 'Remove ' + user + ' as admin?';
        if (!confirm(confirmMsg)) return;
        try {
            await api('/organizations/' + orgId + '/admins', { method: 'DELETE', body: JSON.stringify({ user: user }) });
            showToast('Admin removed');
            render();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteOrg(orgId, orgName) {
        if (!confirm('Delete organization "' + orgName + '"? This will remove all members and admins.')) return;
        try {
            await api('/organizations/' + orgId, { method: 'DELETE' });
            showToast('Organization deleted');
            render();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function emergencyCheck() {
        var userInput = document.getElementById('emergencyUser');
        var dossierInput = document.getElementById('emergencyDossier');
        var targetUser = userInput ? userInput.value.trim() : '';
        var dossierId = dossierInput ? dossierInput.value.trim() : '';
        if (!targetUser || !dossierId) { showToast('Both user and dossier ID are required', 'error'); return; }
        var resultDiv = document.getElementById('emergencyResult');
        try {
            var data = await api('/' + dossierId + '/emergency-check', {
                method: 'POST', body: JSON.stringify({ user: targetUser, relation: 'viewer' })
            });
            var statusText = data.allowed ? 'ACCESS GRANTED' : 'ACCESS DENIED';
            var statusClass = data.allowed ? 'emergency-allowed' : 'emergency-denied';
            resultDiv.textContent = '';
            var div = document.createElement('div');
            div.className = 'emergency-result ' + statusClass;
            div.textContent = statusText + ' — ' + targetUser + ' as viewer on dossier:' + dossierId + ' (contextual tuple)';
            resultDiv.appendChild(div);
        } catch (e) {
            resultDiv.textContent = '';
            var div = document.createElement('div');
            div.className = 'emergency-result emergency-denied';
            div.textContent = 'Error: ' + e.message;
            resultDiv.appendChild(div);
        }
    }

    async function sendGuardianshipRequest() {
        var input = document.getElementById('guardianTarget');
        var to = input ? input.value.trim() : '';
        if (!to) return;
        try {
            await api('/guardianships/request', { method: 'POST', body: JSON.stringify({ to: to }) });
            showToast('Request sent!');
            render();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function acceptGuardianship(id) {
        try {
            await api('/guardianships/' + id + '/accept', { method: 'POST' });
            showToast('Guardianship accepted!');
            render();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function denyGuardianship(id) {
        try {
            await api('/guardianships/' + id + '/deny', { method: 'POST' });
            showToast('Request denied');
            render();
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function removeGuardianship(userId) {
        if (!confirm('Remove guardianship with ' + userId + '?')) return;
        try {
            await api('/guardianships/' + userId, { method: 'DELETE' });
            showToast('Guardianship removed');
            render();
        } catch (e) { showToast(e.message, 'error'); }
    }

    function toggleDebug() {
        var c = document.getElementById('debugContent');
        var a = document.getElementById('debugArrow');
        if (c.style.display === 'none') { c.style.display = 'block'; a.innerHTML = '&#9660;'; refreshDebug(); }
        else { c.style.display = 'none'; a.innerHTML = '&#9654;'; }
    }

    async function refreshDebug() {
        try {
            var data = await api('/debug/tuples');
            var tbody = document.getElementById('debugBody');
            if (!tbody) return;
            var tuples = data.tuples || [];
            tbody.innerHTML = tuples.length === 0 ? '<tr><td colspan="3" class="muted">No tuples</td></tr>' :
                tuples.map(function(t) { return '<tr><td>' + escapeHtml(t.user) + '</td><td>' + escapeHtml(t.relation) + '</td><td>' + escapeHtml(t.object) + '</td></tr>'; }).join('');
        } catch (e) { showToast('Error loading tuples', 'error'); }
    }

    function simpleMarkdown(text) {
        return text
            .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
            .replace(/^#### (.+)$/gm, '<h4>$1</h4>')
            .replace(/^### (.+)$/gm, '<h3>$1</h3>')
            .replace(/^## (.+)$/gm, '<h2>$1</h2>')
            .replace(/^# (.+)$/gm, '<h1>$1</h1>')
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            .replace(/^\s*[-*] (.+)$/gm, '<li>$1</li>')
            .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
            .replace(/\n{2,}/g, '<br><br>')
            .replace(/\n/g, '<br>');
    }

    async function requestAIExplanation() {
        var btn = document.getElementById('aiExplainBtn');
        var resultDiv = document.getElementById('aiExplainResult');
        if (!btn || !resultDiv) return;

        btn.disabled = true;
        btn.innerHTML = '<span class="ai-explain-spinner"></span>Analyzing...';
        resultDiv.innerHTML = '';

        try {
            var results = await Promise.all([
                api('/list'),
                api('/guardianships')
            ]);
            var dossiersData = results[0];
            var guardianshipsData = results[1];

            var allDossiers = dossiersData.dossiers || [];
            var myDossiers = allDossiers.filter(function(d) { return d.owner === currentUser; });
            var sharedDossiers = allDossiers.filter(function(d) { return d.owner !== currentUser; });
            var gList = guardianshipsData.guardians || [];
            var wList = guardianshipsData.wards || [];

            var res = await fetch('/manager/api/explain-authz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user: currentUser,
                    visibleDossiers: allDossiers.map(function(d) { return { title: d.title, type: d.type, owner: d.owner, canEdit: d.canEdit }; }),
                    guardians: gList,
                    wards: wList,
                    myDossiersCount: myDossiers.length,
                    sharedDossiersCount: sharedDossiers.length
                })
            });

            var data = await res.json();
            if (!res.ok) throw new Error(data.error || 'AI Manager request failed');

            resultDiv.innerHTML = '<div class="ai-explain-result">' + simpleMarkdown(data.explanation) + '</div>';
        } catch (e) {
            resultDiv.innerHTML = '<p class="ai-explain-error">Error: ' + escapeHtml(e.message) + '</p>';
        } finally {
            btn.disabled = false;
            btn.textContent = 'Explain My Authorization';
        }
    }

    render();
    </script>
</body>
</html>
