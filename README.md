# Fine-Grained Authorization POC

## üéØ Goal
This project demonstrates a modern **Externalized Authorization** architecture. The goal is to decouple authentication and authorization logic from the application code, moving it into a dedicated infrastructure layer. This approach enables:
*   **Centralized Policy Management**: Security rules are defined in one place, not scattered across codebases.
*   **Polyglot Support**: Works with any backend language (Go, Node, Python, etc.).
*   **Flexibility**: Combines Attribute-Based Access Control (ABAC) and Relationship-Based Access Control (ReBAC).
*   **AI-Driven Management**: Simplifies policy creation using Generative AI.

## üèó Concept & Architecture

The system uses a **Sidecar / Gateway pattern**:

1.  **Intercept**: **Envoy Proxy** acts as the API Gateway. All traffic goes through it.
2.  **Authenticate**: Envoy handles OIDC flows with **Keycloak**, ensuring users are logged in before they reach the app.
3.  **Authorize**: Envoy delegates the "Allow/Deny" decision to **OPA** (Open Policy Agent) via gRPC.
4.  **Enforce**: 
    *   If allowed, the request is forwarded to the application.
    *   If denied, Envoy returns a custom 403 HTML page (generated by OPA).

### Authorization Flow
`User` -> `Envoy` -> `Keycloak (Login)` -> `Envoy` -> `OPA (Policy Check)` -> [`OpenFGA (Relationship Check)`] -> `Backend App`

### Diagram
```mermaid
graph LR
    User[User] --> Envoy[Envoy Proxy :8000]
    Envoy -->|Ext Authz| OPA[OPA :8181]
    OPA -->|ReBAC Check| OpenFGA[OpenFGA :8081]
    Envoy -->|Allowed| App[Test App :3000]
    
    User -->|Manage Rules| AI[AI Manager :5001]
    AI -->|Gen Policy| Gemini[Google Gemini]
    AI -->|Update| OPA
    AI -->|Update| OpenFGA
```

## üß© Services

| Service | Role | Description |
| :--- | :--- | :--- |
| **Envoy Proxy** | **PEP** (Policy Enforcement Point) | The front door. Handles routing, logging, OIDC authentication, and calls OPA for authorization decisions. |
| **Keycloak** | **IdP** (Identity Provider) | Manages users (Alice, Bob) and issues JWT tokens via OpenID Connect. |
| **OPA** | **PDP** (Policy Decision Point) | The "Brain". Evaluates requests against `.rego` policies (ABAC). It decides *if* access is allowed. |
| **OpenFGA** | **ReBAC** Engine | Stores fine-grained relationships (e.g., "Alice *is viewer of* Document A"). OPA can query this for complex checks. |
| **AI Manager** | Management UI | A custom Node.js app powered by **Google Gemini**. It allows you to chat with your policies and generate rules using natural language. |
| **Test App** | Backend Service | The **Citizen Mandate System** ‚Äî a Go application implementing 8 ReBAC scenarios with OpenFGA (ownership, mandates, guardianship, organizations, blocking, public access, emergency access). |
| **Postgres** | Database | Persists data for Keycloak and OpenFGA. |
| **Loki** | Log Aggregation | Centralized log storage for all services. |
| **Promtail** | Log Collector | Scrapes container logs and ships them to Loki. |
| **Grafana** | Dashboards | Log exploration and monitoring with Keycloak SSO integration. |

## üöÄ Quick Start

### Prerequisites
*   Podman (or Docker)
*   Google Gemini API Key (for AI Manager)

### Setup
1.  **Configure Environment**:
    ```bash
    cp .env.example .env
    # Edit .env ‚Äî set GEMINI_API_KEY at minimum
    ```

2.  **Run the Stack**:
    ```bash
    podman compose up --build -d
    ```

3.  **Keycloak** (automatic):
    The realm, client, and users are imported automatically on first boot from `infra/keycloak/realm.json` via Keycloak's `--import-realm` flag.

### Usage
*   **Public Access**: [http://localhost:8000/public](http://localhost:8000/public)
*   **Protected Access**: [http://localhost:8000/api/protected](http://localhost:8000/api/protected)
    *   Redirects to Keycloak. Login with `alice` / `alice`.
*   **Citizen Mandate System**: [http://localhost:8000/dossiers](http://localhost:8000/dossiers)
    *   Manage dossiers with ReBAC: organizations, mandates, guardianships, public/blocked access.
*   **AI Manager**: [http://localhost:8000/manager](http://localhost:8000/manager)
    *   Chat with your policies or generate new ones.
*   **Grafana**: [http://localhost:8000/grafana](http://localhost:8000/grafana)
    *   Log exploration and dashboards (SSO via Keycloak).

## üñ• Running on Synology NAS

This project can run on a Synology NAS using Docker (Container Manager). The project lives at `/volume1/docker/authz_poc/`.

### Prerequisites
*   Synology DSM with **Container Manager** (Docker) installed
*   SSH access enabled on the NAS
*   Google Gemini API Key (for AI Manager)

### Setup

1.  **Clone the repo** via SSH:
    ```bash
    ssh your-nas
    cd /volume1/docker
    git clone <repo-url> authz_poc
    cd authz_poc
    ```

2.  **Configure environment**:
    ```bash
    echo "GEMINI_API_KEY=AIzaSy..." > /volume1/docker/authz_poc/.env
    ```

3.  **Set the external URL** to your NAS IP or hostname. Edit the `docker-compose.yml` and update the `EXTERNAL_URL` environment variable for both the `envoy` and `test-app` services:
    ```yaml
    # In the envoy service:
    environment:
      EXTERNAL_URL: http://<NAS_IP>:8000

    # In the test-app service:
    environment:
      EXTERNAL_URL: http://<NAS_IP>:8000
    ```
    Replace `<NAS_IP>` with your Synology's local IP (e.g., `192.168.1.50`) or hostname.

4.  **Build and start** the stack:
    ```bash
    cd /volume1/docker/authz_poc
    docker compose build
    docker compose up -d
    ```

5.  **Update Keycloak redirect URIs** if using a custom hostname or IP. The realm config (`infra/keycloak/realm.json`) already includes `http://localhost:8000/*` in `redirectUris`. Add your NAS URL:
    ```json
    "redirectUris": ["http://localhost:8000/*", "http://<NAS_IP>:8000/*"],
    "webOrigins": ["http://localhost:8000", "http://<NAS_IP>:8000"],
    ```
    Then restart Keycloak: `docker compose restart keycloak`

### Synology-specific notes

*   **OPA platform**: The OPA image uses `platform: linux/amd64`. This works on x86 Synology models (DS920+, DS1621+, etc.). ARM-based models (DS220j, etc.) are not supported.
*   **Port conflicts**: If ports `8000`, `8081`, or `8181` conflict with other services on your NAS, remap them in `docker-compose.yml` under the relevant `ports:` sections.
*   **Persistence**: Postgres data, OpenFGA config, and app data use Docker named volumes. These survive container restarts and are stored in `/volume1/@docker/volumes/`.
*   **Firewall**: If the Synology firewall is enabled, allow inbound TCP on port `8000` (or your remapped port) for LAN access.
*   **Auto-start**: Container Manager automatically restarts containers after a NAS reboot if the restart policy is set. Add `restart: unless-stopped` to each service in `docker-compose.yml` for this behavior.
*   **Logs**: View logs via Container Manager UI or SSH:
    ```bash
    cd /volume1/docker/authz_poc
    docker compose logs -f envoy
    docker compose logs -f test-app
    ```

### Access

*   **Public page**: `http://<NAS_IP>:8000/public`
*   **Authenticated home**: `http://<NAS_IP>:8000/home` (redirects to Keycloak login)
*   **AI Manager**: `http://<NAS_IP>:8000/manager`

## üîê ReBAC Scenarios (Citizen Mandate System)

The test-app implements 8 relationship-based access control patterns using OpenFGA:

| # | Scenario | Pattern |
|---|----------|---------|
| 1 | Direct Ownership | Direct relation |
| 2 | Mandate Delegation | Direct relation |
| 3 | Guardian Traversal | `tupleToUserset` |
| 4 | Guardianship Workflow | Request/Accept/Deny/Remove |
| 5 | Organization Access | `tupleToUserset` on organization type |
| 6 | User Blocking | `difference` (exclusion / deny-override) |
| 7 | Public Dossiers | Wildcard `user:*` |
| 8 | Emergency Access | Contextual tuples (non-persisted) |

See [docs/REBAC-SCENARIOS.md](docs/REBAC-SCENARIOS.md) for detailed descriptions, API endpoints, tuple examples, and test references.

## üìÇ Project Structure
*   `infra/envoy/`: Envoy proxy configuration.
*   `infra/opa/`: OPA configuration and `.rego` policies.
*   `infra/openfga/`: OpenFGA authorization model bootstrap (`init.js`).
*   `infra/keycloak/`: Keycloak realm config and custom login theme.
*   `infra/postgres/`: Database initialization scripts.
*   `infra/grafana/`: Grafana dashboards and provisioning.
*   `infra/loki/`: Loki log aggregation config.
*   `infra/promtail/`: Promtail log collector config.
*   `ai-manager/`: Source code for the AI management interface.
*   `test-app/`: Citizen Mandate System (Go) ‚Äî dossier management with ReBAC.
*   `docs/`: Project documentation.

## üìñ Documentation

*   [ReBAC Scenarios](docs/REBAC-SCENARIOS.md) ‚Äî All 8 authorization patterns with examples
*   [Contributing Guide](docs/CONTRIB.md) ‚Äî Development workflow, env vars, testing
*   [Operations Runbook](docs/RUNBOOK.md) ‚Äî Deployment, monitoring, troubleshooting
