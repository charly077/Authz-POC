<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuthZ AI Manager</title>
    <base href="/manager/">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,600;0,9..144,700;1,9..144,400&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: false, theme: 'default', securityLevel: 'loose' });
        window.mermaid = mermaid;
    </script>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-row">
                <div>
                    <h1>AI Authorization Manager</h1>
                    <p>Define policies using natural language. We handle the rest.</p>
                </div>
                <div class="header-actions">
                    <a href="/grafana" class="secondary-btn" target="_blank">Grafana</a>
                    <a href="auth/logout" class="logout-btn">Logout</a>
                </div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" data-tab="generate">Generate Rules</button>
            <button class="tab-btn" data-tab="chat">View & Chat</button>
            <button class="tab-btn" data-tab="openfga">OpenFGA Manager</button>
            <button class="tab-btn" data-tab="visualize">Visualization</button>
            <button class="tab-btn" data-tab="audit">Audit Log</button>
        </div>

        <main id="generate" class="tab-content active">
            <div class="card input-section">
                <h2>Describe your Policy</h2>
                <textarea id="promptInput"
                    placeholder="e.g., Allow editors to view documents they created..."></textarea>
                <div class="actions">
                    <button id="generateBtn" class="primary-btn">Generate Rule</button>
                </div>
            </div>

            <div class="card output-section output-disabled" id="outputCard">
                <h2>Generated Configuration</h2>
                <div class="badge" id="typeBadge">OPA</div>
                <pre><code id="codeOutput">Waiting for input...</code></pre>
                <p id="explanation"></p>
                <div class="actions">
                    <button id="applyBtn" class="secondary-btn">Apply Policy</button>
                </div>
            </div>
        </main>

        <main id="chat" class="tab-content">
            <div class="chat-layout">
                <div class="rules-view">
                    <h3>Current Rules</h3>
                    <div class="rule-block">
                        <h4>OPA Policy (Rego)</h4>
                        <pre><code id="opaContent">Loading...</code></pre>
                    </div>
                </div>
                <div class="chat-interface">
                    <h3>AI Assistant</h3>
                    <div id="chatHistory" class="chat-history">
                        <div class="message ai">Hello! I've analyzed your current policies. Ask me anything about them.
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="chatInput" placeholder="Ask about the rules...">
                        <button id="sendChatBtn" class="primary-btn">Send</button>
                    </div>
                </div>
            </div>
        </main>

        <main id="openfga" class="tab-content">
            <div class="fga-status card" id="fgaStatus">
                <h3>OpenFGA Status</h3>
                <p id="fgaStatusText">Checking...</p>
            </div>

            <div class="card">
                <h3>Tuples</h3>
                <div class="fga-filter-row">
                    <input type="text" id="filterUser" placeholder="Filter by user (e.g. user:alice)">
                    <input type="text" id="filterRelation" placeholder="Filter by relation">
                    <input type="text" id="filterObject" placeholder="Filter by object">
                    <button class="secondary-btn" id="filterTuplesBtn">Filter</button>
                    <button class="secondary-btn" id="refreshTuplesBtn">Refresh</button>
                </div>
                <table class="fga-table" id="tuplesTable">
                    <thead><tr><th>User</th><th>Relation</th><th>Object</th><th></th></tr></thead>
                    <tbody id="tuplesBody"></tbody>
                </table>
            </div>

            <div class="card">
                <h3>Add Tuple</h3>
                <div class="fga-add-row">
                    <input type="text" id="addUser" placeholder="user:alice">
                    <input type="text" id="addRelation" placeholder="owner">
                    <input type="text" id="addObject" placeholder="dossier:abc123">
                    <button class="primary-btn" id="addTupleBtn">Add</button>
                </div>
            </div>

            <div class="card">
                <h3>Check Authorization</h3>
                <div class="fga-add-row">
                    <input type="text" id="checkUser" placeholder="user:alice">
                    <input type="text" id="checkRelation" placeholder="viewer">
                    <input type="text" id="checkObject" placeholder="dossier:abc123">
                    <button class="primary-btn" id="checkBtn">Check</button>
                </div>
                <div id="checkResult" class="fga-check-result"></div>
            </div>

            <div class="card">
                <h3>Authorization Model</h3>
                <pre><code id="fgaModelContent">Loading...</code></pre>
                <button class="secondary-btn" id="refreshModelBtn">Refresh Model</button>
            </div>

            <div class="card">
                <div class="viz-header">
                    <h3>Organizations</h3>
                    <button class="secondary-btn small-btn" id="refreshOrgsBtn">Refresh</button>
                </div>
                <p class="muted" style="margin-bottom: 1rem;">Manage organization admins and delete organizations. Members can be managed in the <a href="/dossiers" target="_blank">Dossiers app</a>.</p>
                <div id="orgsContainer">
                    <p class="muted">Loading organizations...</p>
                </div>
            </div>
        </main>
        <main id="visualize" class="tab-content">
            <div class="card">
                <div class="viz-header">
                    <h2>Architecture Overview</h2>
                    <button class="secondary-btn small-btn" id="refreshArchBtn">Refresh</button>
                </div>
                <div class="mermaid-container" id="archContainer"></div>
                <div class="arch-explanation">
                    <p>This system uses a <strong>two-layer authorization</strong> architecture to secure every request, backed by a shared PostgreSQL database and a centralized observability stack.</p>
                    <div class="arch-grid">
                        <div class="arch-item">
                            <h4>Envoy Proxy</h4>
                            <p>Sits in front of the application as a reverse proxy and acts as the single enforcement point. It runs two filters in sequence: first, the <strong>OAuth2 filter</strong> checks if the request carries a valid token â€” if not, it redirects the browser to Keycloak for login and handles the token exchange on <code>/callback</code>. Then the <strong>ext_authz filter</strong> sends every authenticated request to OPA for policy evaluation. The app never sees unauthenticated or unauthorized traffic.</p>
                        </div>
                        <div class="arch-item">
                            <h4>Keycloak (IdP)</h4>
                            <p>Identity Provider that manages user accounts, login screens, and role assignments. Envoy redirects unauthenticated users here for OIDC login. After the user authenticates, Keycloak issues a JWT token containing claims (username, roles, email) that Envoy forwards with every subsequent request.</p>
                        </div>
                        <div class="arch-item">
                            <h4>OPA (Open Policy Agent)</h4>
                            <p>Handles <strong>coarse-grained, path-level</strong> authorization. Envoy sends each request to OPA via gRPC ext_authz. OPA evaluates Rego policies against the URL path, HTTP method, and JWT claims to decide allow or deny. Answers: <em>"Can this user access this endpoint?"</em></p>
                        </div>
                        <div class="arch-item">
                            <h4>OpenFGA</h4>
                            <p>Handles <strong>fine-grained, relationship-based</strong> access control (ReBAC). Called by the application (not Envoy) to check per-object permissions. Models ownership, friendship, and sharing relationships between users and resources. Answers: <em>"Can this user view/edit this specific object?"</em></p>
                        </div>
                        <div class="arch-item">
                            <h4>Test-App (Go)</h4>
                            <p>A protected demo application written in Go that sits behind Envoy. Demonstrates ReBAC integration by calling OpenFGA for per-object permission checks. Serves as a reference implementation for services consuming the authorization stack.</p>
                        </div>
                        <div class="arch-item">
                            <h4>PostgreSQL</h4>
                            <p>Shared relational database backing both <strong>Keycloak</strong> (user accounts, realm config, sessions) and <strong>OpenFGA</strong> (authorization model, relationship tuples). A single instance with separate logical databases keeps the deployment simple.</p>
                        </div>
                        <div class="arch-item">
                            <h4>Loki + Promtail</h4>
                            <p><strong>Promtail</strong> tails container logs from every service and ships them to <strong>Loki</strong>, a lightweight log-aggregation engine. Together they provide centralised, searchable logging with label-based indexing and a 72-hour retention window.</p>
                        </div>
                        <div class="arch-item">
                            <h4>Grafana</h4>
                            <p>Observability dashboard routed behind Envoy at <code>/grafana</code> with Keycloak SSO. Queries Loki for log exploration, provides pre-built dashboards for authorization decisions, error rates, and system health. Acts as the single pane of glass for the platform.</p>
                        </div>
                    </div>
                    <div class="arch-item arch-comparison">
                        <h4>OPA vs OpenFGA</h4>
                        <p><strong>OPA</strong> is policy-based: rules are written in Rego and evaluate request attributes (path, method, token claims). It operates at the <em>API gateway level</em> and knows nothing about individual resources.</p>
                        <p><strong>OpenFGA</strong> is relationship-based: it stores tuples like <code>user:alice is owner of dossier:d1</code> and evaluates access by traversing the relationship graph. It operates at the <em>application level</em> for per-object decisions.</p>
                        <p>Together they form a defense-in-depth pattern: OPA gates the door, OpenFGA controls what you see inside.</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="viz-header">
                    <h2>OPA Policy Flow</h2>
                    <button class="secondary-btn small-btn" id="refreshOpaVizBtn">Refresh</button>
                </div>
                <div class="mermaid-container" id="opaVizContainer"></div>
            </div>

            <div class="card">
                <div class="viz-header">
                    <h2>OpenFGA Model &amp; Relations</h2>
                    <button class="secondary-btn small-btn" id="refreshFgaVizBtn">Refresh</button>
                </div>
                <div class="mermaid-container" id="fgaVizContainer"></div>
            </div>
        </main>

        <main id="audit" class="tab-content">
            <div class="card">
                <div class="viz-header">
                    <h2>Audit Log</h2>
                    <button class="secondary-btn small-btn" id="refreshAuditBtn">Refresh</button>
                </div>
                <div class="audit-filters">
                    <select id="auditSourceFilter">
                        <option value="all">All Sources</option>
                        <option value="OPA">OPA</option>
                        <option value="OpenFGA">OpenFGA</option>
                    </select>
                    <select id="auditDecisionFilter">
                        <option value="all">All Decisions</option>
                        <option value="allow">Allow</option>
                        <option value="deny">Deny</option>
                    </select>
                    <input type="text" id="auditUserFilter" placeholder="Filter by user...">
                    <label class="auto-refresh-label">
                        <input type="checkbox" id="auditAutoRefresh" checked>
                        Auto-refresh
                    </label>
                </div>
                <p class="muted" style="margin-bottom: 1rem;">More information available in <a href="/grafana" target="_blank">Grafana</a> (SSO with Keycloak)</p>
                <table class="fga-table" id="auditTable">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Source</th>
                            <th>Decision</th>
                            <th>User</th>
                            <th>Path / Resource</th>
                            <th>Method</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody id="auditBody">
                        <tr><td colspan="7" class="muted">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>
    <script src="app.js"></script>
</body>

</html>
